#!/bin/bash
until
echo -e "\033[44;37m+—————————————————————————+\033[0m"
echo -e "\033[44;37m|   E L I M I N C U Z F   |\033[0m"
echo -e "\033[44;37m|      交互式搭建脚本     |\033[0m"
echo -e "\033[44;37m+—————————————————————————+\033[0m"
echo -e "\033[44;37m|1. ◎搭建VPN(pptpd)       |\033[0m"
echo -e "\033[44;37m|2. ◎添加用户             |\033[0m"
echo -e "\033[44;37m|3. ◎修改dns节点          |\033[0m"
echo -e "\033[44;37m|0. ◎退出菜单             |\033[0m"
echo -e "\033[44;37m+—————————————————————————+\033[0m"
        echo -en "[\033[34m输\033[0m\033[31m入\033[0m\033[32m序\033[0m\033[33m号\033[0m]:"
        read zhongduan
        test $zhongduan = 0 &>/dev/null
        do
                case $zhongduan in

1)read -p '确认搭建PPTPD[y/n]:' pd
if [ $pd == y ];then
echo -e "\033[32m【任务开始！！】\033[0m"
else
echo -e "\033[31m【输入错误!】\033[0m"
fi
yum -y install iptables-services pptpd
echo 【依赖安装完成】
systemctl stop firewalld &>/dev/null
systemctl disable firewalld &>/dev/null
sed -i '102,103s/^#//g' /etc/pptpd.conf &>/dev/null
echo 【配置设置成功】
read -p '创建pptpd用户:' yonghu
stty -echo
read -p '创建pptpd密码:' mima
stty echo
echo $yonghu pptpd $mima '*' >> /etc/ppp/chap-secrets
echo 用户写入完成
grep nameserver /etc/resolv.conf &>/dev/null
echo $？ &>/dev/null
if [ $? -ge 0 ];then
sed -n 's/nameserver/ms-dns/p' /etc/resolv.conf >> /etc/ppp/options.pptpd
else
sed -i 's/^ms-dns .*//g' /etc/ppp/options.pptpd
#sed -i 's/^ms-dns/#ms-dns/g' /etc/ppp/options.pptpd
echo 'ms-dns 8.8.8.8
ms-dns 8.8.4.4' >> /etc/ppp/options.pptpd
fi
echo 【dns节点修改成功】
systemctl start iptables
systemctl enable iptables &>/dev/null
iptables -F
iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE
iptables -I FORWARD -p tcp --syn -i ppp+ -j TCPMSS --set-mss 1356
service iptables save &>/dev/null
systemctl restart iptables
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p &>/dev/null
echo 【防火墙配置完成】
systemctl start pptpd
systemctl enable pptpd
netstat -untpl |grep 1723 &>/dev/null
echo $? &>/dev/null
if [ $? -ge 0 ];then
echo 【PPTPD服务搭建成功】
echo 用户：$yonghu
echo 密码：$mima
else
echo '【PPTPD服务搭建失败】'
fi
exit;;

2)read -p '添加用户:' yonghu
stty -echo
read -p '创建pptpd密码:' mima
stty echo
echo $yonghu pptpd $mima '*' >> /etc/ppp/chap-secrets && exit;;

3)read -p '修改dns节点1(格式:8.8.8.8):' dns1
read -p '修改dns节点2(格式:8.8.4.4):' dns2
sed -i 's/^#ms-dns/ms-dns/p' /etc/ppp/options.pptpd &>/dev/null
sed -i 's/^ms-dns .*//p' /etc/ppp/options.pptpd &>/dev/null
echo ms-dns $dns1 >> /etc/ppp/options.pptpd
echo ms-dns $dns2 >> /etc/ppp/options.pptpd
exit;;

0)echo "请选择输入 (0-3)"
esac
done
